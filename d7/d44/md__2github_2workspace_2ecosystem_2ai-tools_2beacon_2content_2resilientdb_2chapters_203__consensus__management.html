#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
<!-- HTML header for doxygen 1.9.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ResilientDB: 03_consensus_management</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen_html_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../logo.png"/></td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(1); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d7/d44/md__2github_2workspace_2ecosystem_2ai-tools_2beacon_2content_2resilientdb_2chapters_203__consensus__management.html','../../'); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">03_consensus_management</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><hr  />
<p> layout: default title: 'Chapter 3: Consensus Management' parent: 'ResilientDB' </p>
<h2><a class="anchor" id="autotoc_md104"></a>
nav_order: 3</h2>
<h1><a class="anchor" id="autotoc_md105"></a>
Chapter 3: Consensus Management</h1>
<p>In the previous chapter, <a class="el" href="../../d5/db7/md__2github_2workspace_2ecosystem_2ai-tools_2beacon_2content_2resilientdb_2chapters_202__network__communication.html">Chapter 2: Network Communication</a>, we learned how the different computers (replicas) in the ResilientDB network reliably send and receive messages using components like <code>ReplicaCommunicator</code> and <code><a class="el" href="../../d7/d96/classServiceNetwork.html">ServiceNetwork</a></code>. It's like having a dependable postal service and phone system.</p>
<p>But <em>what</em> important conversations are happening over these communication lines? How do the replicas use these messages to agree on the single, correct order of operations, even if some of them are slow, faulty, or even trying to cheat?</p>
<p>Welcome to Chapter 3! We'll dive into the brain of the agreement process: <b>Consensus Management</b>, primarily handled by the <code>ConsensusManager</code>.</p>
<h2><a class="anchor" id="autotoc_md106"></a>
The Need for Agreement: Why Consensus?</h2>
<p>Imagine a shared digital bulletin board where several people can post notes (transactions). Everyone needs to see the <em>same notes</em> in the <em>same order</em>.</p>
<ul>
<li>What if two people try to post a note at the exact same time? Which one comes first?</li>
<li>What if one person's internet connection is flaky, and their notes arrive late or out of order for some viewers?</li>
<li>Worse, what if someone tries to sneakily change the order of notes already posted or tries to prevent valid notes from appearing?</li>
</ul>
<p>A simple database running on one computer doesn't have these problems. But ResilientDB is a <em>distributed</em> database, run by a team of replicas. To maintain a consistent and trustworthy database state across all replicas, they <em>must</em> agree on the exact sequence of transactions. This process of reaching agreement in a distributed system, especially one where some participants might be unreliable or malicious (these are called "Byzantine faults"), is called <b>consensus</b>.</p>
<p>ResilientDB uses sophisticated algorithms like <b>Practical Byzantine Fault Tolerance (PBFT)</b> to achieve this. PBFT is designed to work correctly even if a certain number of replicas (up to <code>f</code> out of <code>3f+1</code> total replicas) are behaving incorrectly.</p>
<h2><a class="anchor" id="autotoc_md107"></a>
Meet the Chief Negotiator: <code>ConsensusManager</code></h2>
<p>The <code>ConsensusManager</code> is the core component within each ResilientDB replica responsible for implementing and orchestrating the consensus algorithm (like PBFT).</p>
<p><b>Analogy:</b> Think of the <code>ConsensusManager</code> as the <b>chief negotiator</b> or <b>meeting facilitator</b> in a high-stakes meeting (ordering transactions). Its job is to:</p>
<ol type="1">
<li>Receive proposed transactions (often initiated by clients via Chapter 1).</li>
<li>Guide the discussion (exchange messages with other replicas' <code>ConsensusManager</code>s using the tools from Chapter 2).</li>
<li>Ensure that all honest participants reach the <em>same decision</em> about the transaction order, despite potential disagreements or disruptions from faulty participants.</li>
<li>Announce the final, agreed-upon order so the transaction can be executed.</li>
</ol>
<p>It's the engine that drives the replicas towards a unified view of the transaction history.</p>
<h2><a class="anchor" id="autotoc_md108"></a>
How Consensus Works (A Simplified PBFT View)</h2>
<p>PBFT works in phases, involving message exchanges between replicas. Here's a simplified overview:</p>
<ol type="1">
<li><b>Client Request:</b> A client sends a transaction request (e.g., "Set key 'A' to value '10'") to the ResilientDB network, usually targeting the current leader replica (called the "Primary"). (See Chapter 1).</li>
<li><b>Pre-Prepare (Proposal):</b> The Primary replica receives the client request. If it deems it valid, it assigns a sequence number (determining its order) and broadcasts a <code>PRE-PREPARE</code> message to all other replicas (called "Backups"). This message basically says, "I propose we process this transaction with sequence number N."</li>
<li><b>Prepare (Voting):</b> When a Backup replica receives the <code>PRE-PREPARE</code> message, it validates it. If it looks good (correct sequence number, valid request format, etc.), the Backup broadcasts a <code>PREPARE</code> message to all other replicas (including the Primary). This message means, "I've seen the proposal for sequence N, and it looks okay to me. I'm prepared to accept it."</li>
<li><b>Commit (Confirming):</b> Each replica (Primary and Backups) waits until it receives enough (<code>2f+1</code> including its own vote, where <code>f</code> is the max number of faulty replicas tolerated) matching <code>PREPARE</code> messages for the same sequence number N from different replicas. Seeing these votes convinces the replica that enough <em>other</em> honest replicas also agree on the proposal. The replica then broadcasts a <code>COMMIT</code> message, signifying "I've seen enough agreement ('Prepared' certificate); I am now ready to commit to sequence number N."</li>
<li><b>Execute (Decision):</b> Each replica waits until it receives enough (<code>2f+1</code>) matching <code>COMMIT</code> messages for sequence number N. This forms the final proof ("Committed" certificate) that the transaction is agreed upon by the network. The replica now knows the transaction is finalized in the agreed order. It can safely execute the transaction (e.g., actually update the key 'A' to '10') and potentially store the result. This execution step is handled by components discussed in Chapter 5: Transaction Execution (TransactionManager / TransactionExecutor).</li>
</ol>
<p>This multi-phase process ensures that even if the Primary is malicious or some Backups are faulty, the honest replicas will eventually agree on the same order for valid transactions.</p>
<h2><a class="anchor" id="autotoc_md109"></a>
Code Sneak Peek: The <code>ConsensusManagerPBFT</code></h2>
<p>ResilientDB implements PBFT consensus within the <code><a class="el" href="../../d3/d20/classConsensusManagerPBFT.html">ConsensusManagerPBFT</a></code> class. It inherits from a base <code>ConsensusManager</code> and handles the specifics of PBFT.</p>
<p>One of the key functions is <code>ConsensusCommit</code>. This function acts like the central dispatcher within the <code><a class="el" href="../../d3/d20/classConsensusManagerPBFT.html">ConsensusManagerPBFT</a></code>. When a message related to consensus arrives from the network (via the <code><a class="el" href="../../d7/d96/classServiceNetwork.html">ServiceNetwork</a></code> from Chapter 2), it's eventually passed to this function.</p>
<div class="fragment"><div class="line"><span class="comment">// Simplified from platform/consensus/ordering/pbft/consensus_manager_pbft.cpp</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// This function receives consensus-related messages after initial network processing.</span></div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../d3/d20/classConsensusManagerPBFT.html#a8e4ec0f20a2fb7a0d08868292647d8bf">ConsensusManagerPBFT::ConsensusCommit</a>(std::unique_ptr&lt;Context&gt; context,</div>
<div class="line">                                          std::unique_ptr&lt;Request&gt; request) {</div>
<div class="line">  <span class="comment">// ... (Code for handling view changes, checking if ready) ...</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Call the internal function to handle different message types</span></div>
<div class="line">  <span class="keywordtype">int</span> ret = <a class="code hl_function" href="../../d3/d20/classConsensusManagerPBFT.html#a87e731937645a0f0a718fa9ffc7a164b">InternalConsensusCommit</a>(std::move(context), std::move(request));</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// ... (Code for handling outcomes, potential view changes) ...</span></div>
<div class="line">  <span class="keywordflow">return</span> ret;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// This function routes the message based on its type.</span></div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="../../d3/d20/classConsensusManagerPBFT.html#a87e731937645a0f0a718fa9ffc7a164b">ConsensusManagerPBFT::InternalConsensusCommit</a>(</div>
<div class="line">    std::unique_ptr&lt;Context&gt; context, std::unique_ptr&lt;Request&gt; request) {</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Check the type of message received</span></div>
<div class="line">  <span class="keywordflow">switch</span> (request-&gt;type()) {</div>
<div class="line">    <span class="comment">// If it&#39;s a brand new transaction proposal from a client (relayed by primary):</span></div>
<div class="line">    <span class="keywordflow">case</span> Request::TYPE_NEW_TXNS:</div>
<div class="line">      <span class="comment">// Pass it to the &#39;Commitment&#39; component to start the PBFT process</span></div>
<div class="line">      <span class="comment">// (This happens on the Primary replica)</span></div>
<div class="line">      <span class="keywordflow">return</span> <a class="code hl_variable" href="../../d3/d20/classConsensusManagerPBFT.html#a0bb059cb8033948187fa8f10f3e80118">commitment_</a>-&gt;ProcessNewRequest(std::move(context), std::move(request));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// If it&#39;s a PRE-PREPARE message (proposal from the primary):</span></div>
<div class="line">    <span class="keywordflow">case</span> Request::TYPE_PRE_PREPARE:</div>
<div class="line">      <span class="comment">// Pass it to the &#39;Commitment&#39; component to handle the proposal</span></div>
<div class="line">      <span class="comment">// (This happens on Backup replicas)</span></div>
<div class="line">      <span class="keywordflow">return</span> <a class="code hl_variable" href="../../d3/d20/classConsensusManagerPBFT.html#a0bb059cb8033948187fa8f10f3e80118">commitment_</a>-&gt;ProcessProposeMsg(std::move(context), std::move(request));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// If it&#39;s a PREPARE message (a vote):</span></div>
<div class="line">    <span class="keywordflow">case</span> Request::TYPE_PREPARE:</div>
<div class="line">      <span class="comment">// Pass it to &#39;Commitment&#39; to collect Prepare votes</span></div>
<div class="line">      <span class="keywordflow">return</span> <a class="code hl_variable" href="../../d3/d20/classConsensusManagerPBFT.html#a0bb059cb8033948187fa8f10f3e80118">commitment_</a>-&gt;ProcessPrepareMsg(std::move(context), std::move(request));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// If it&#39;s a COMMIT message (a confirmation vote):</span></div>
<div class="line">    <span class="keywordflow">case</span> Request::TYPE_COMMIT:</div>
<div class="line">      <span class="comment">// Pass it to &#39;Commitment&#39; to collect Commit votes</span></div>
<div class="line">      <span class="keywordflow">return</span> <a class="code hl_variable" href="../../d3/d20/classConsensusManagerPBFT.html#a0bb059cb8033948187fa8f10f3e80118">commitment_</a>-&gt;ProcessCommitMsg(std::move(context), std::move(request));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Handle other message types like Checkpoints, View Changes, Queries...</span></div>
<div class="line">    <span class="keywordflow">case</span> Request::TYPE_CHECKPOINT:</div>
<div class="line">      <span class="keywordflow">return</span> <a class="code hl_variable" href="../../d3/d20/classConsensusManagerPBFT.html#a5604c03e4e4f5bc0f424f40e16b5e73f">checkpoint_manager_</a>-&gt;ProcessCheckPoint(std::move(context), std::move(request));</div>
<div class="line">    <span class="keywordflow">case</span> Request::TYPE_VIEWCHANGE:</div>
<div class="line">      <span class="keywordflow">return</span> <a class="code hl_variable" href="../../d3/d20/classConsensusManagerPBFT.html#aa15421f4ebe10f35696129ae4257a627">view_change_manager_</a>-&gt;ProcessViewChange(std::move(context), std::move(request));</div>
<div class="line">    <span class="comment">// ... other cases ...</span></div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> 0; <span class="comment">// Default return</span></div>
<div class="line">}</div>
<div class="ttc" id="aclassConsensusManagerPBFT_html_a0bb059cb8033948187fa8f10f3e80118"><div class="ttname"><a href="../../d3/d20/classConsensusManagerPBFT.html#a0bb059cb8033948187fa8f10f3e80118">ConsensusManagerPBFT::commitment_</a></div><div class="ttdeci">std::unique_ptr&lt; Commitment &gt; commitment_</div><div class="ttdef"><b>Definition</b> <a href="../../d9/d6c/consensus__manager__pbft_8h_source.html#l00082">consensus_manager_pbft.h:82</a></div></div>
<div class="ttc" id="aclassConsensusManagerPBFT_html_a5604c03e4e4f5bc0f424f40e16b5e73f"><div class="ttname"><a href="../../d3/d20/classConsensusManagerPBFT.html#a5604c03e4e4f5bc0f424f40e16b5e73f">ConsensusManagerPBFT::checkpoint_manager_</a></div><div class="ttdeci">std::unique_ptr&lt; CheckPointManager &gt; checkpoint_manager_</div><div class="ttdef"><b>Definition</b> <a href="../../d9/d6c/consensus__manager__pbft_8h_source.html#l00080">consensus_manager_pbft.h:80</a></div></div>
<div class="ttc" id="aclassConsensusManagerPBFT_html_a87e731937645a0f0a718fa9ffc7a164b"><div class="ttname"><a href="../../d3/d20/classConsensusManagerPBFT.html#a87e731937645a0f0a718fa9ffc7a164b">ConsensusManagerPBFT::InternalConsensusCommit</a></div><div class="ttdeci">int InternalConsensusCommit(std::unique_ptr&lt; Context &gt; context, std::unique_ptr&lt; Request &gt; request)</div><div class="ttdef"><b>Definition</b> <a href="../../de/de1/consensus__manager__pbft_8cpp_source.html#l00197">consensus_manager_pbft.cpp:197</a></div></div>
<div class="ttc" id="aclassConsensusManagerPBFT_html_a8e4ec0f20a2fb7a0d08868292647d8bf"><div class="ttname"><a href="../../d3/d20/classConsensusManagerPBFT.html#a8e4ec0f20a2fb7a0d08868292647d8bf">ConsensusManagerPBFT::ConsensusCommit</a></div><div class="ttdeci">int ConsensusCommit(std::unique_ptr&lt; Context &gt; context, std::unique_ptr&lt; Request &gt; request) override</div><div class="ttdef"><b>Definition</b> <a href="../../de/de1/consensus__manager__pbft_8cpp_source.html#l00149">consensus_manager_pbft.cpp:149</a></div></div>
<div class="ttc" id="aclassConsensusManagerPBFT_html_aa15421f4ebe10f35696129ae4257a627"><div class="ttname"><a href="../../d3/d20/classConsensusManagerPBFT.html#aa15421f4ebe10f35696129ae4257a627">ConsensusManagerPBFT::view_change_manager_</a></div><div class="ttdeci">std::unique_ptr&lt; ViewChangeManager &gt; view_change_manager_</div><div class="ttdef"><b>Definition</b> <a href="../../d9/d6c/consensus__manager__pbft_8h_source.html#l00086">consensus_manager_pbft.h:86</a></div></div>
</div><!-- fragment --><p><b>Explanation:</b></p>
<ul>
<li><code>ConsensusCommit</code> is the entry point. It might do some initial checks (like handling view changes, which occur if the leader is suspected to be faulty).</li>
<li><code>InternalConsensusCommit</code> does the main work: it looks at the <code>request-&gt;type()</code> to see what kind of message it is (<code>PRE_PREPARE</code>, <code>PREPARE</code>, <code>COMMIT</code>, etc.).</li>
<li>Based on the type, it calls the appropriate processing function, often belonging to helper components like <code>commitment_</code>, <code>checkpoint_manager_</code>, or <code>view_change_manager_</code>.</li>
<li>The <code>commitment_</code> object (an instance of the <code>Commitment</code> class) is particularly important, as it manages the core state machine of the PBFT protocol (tracking the pre-prepare, prepare, and commit phases for each transaction).</li>
</ul>
<p>This shows how <code><a class="el" href="../../d3/d20/classConsensusManagerPBFT.html">ConsensusManagerPBFT</a></code> acts as a coordinator, receiving messages and delegating the detailed processing to specialized sub-components.</p>
<h2><a class="anchor" id="autotoc_md110"></a>
Internal Implementation Walkthrough</h2>
<p>Let's visualize the simplified PBFT flow for a client request:</p>
<div class="fragment"><div class="line">sequenceDiagram</div>
<div class="line">    participant Client</div>
<div class="line">    participant Primary as &quot;Primary Replica (ConsensusManager)&quot;</div>
<div class="line">    participant Backup1 as &quot;Backup Replica 1 (CM)&quot;</div>
<div class="line">    participant Backup2 as &quot;Backup Replica 2 (CM)&quot;</div>
<div class="line">    participant Executor as &quot;Transaction Executor&quot;</div>
<div class="line"> </div>
<div class="line">    Client-&gt;&gt;Primary: Send Transaction Request (e.g., SET A=10)</div>
<div class="line">    Primary-&gt;&gt;Primary: Assign Sequence Number (e.g., N=5)</div>
<div class="line">    Primary-&gt;&gt;Backup1: Broadcast PRE-PREPARE (N=5, Req)</div>
<div class="line">    Primary-&gt;&gt;Backup2: Broadcast PRE-PREPARE (N=5, Req)</div>
<div class="line">    Backup1-&gt;&gt;Primary: Send PREPARE (N=5)</div>
<div class="line">    Backup1-&gt;&gt;Backup2: Send PREPARE (N=5)</div>
<div class="line">    Backup2-&gt;&gt;Primary: Send PREPARE (N=5)</div>
<div class="line">    Backup2-&gt;&gt;Backup1: Send PREPARE (N=5)</div>
<div class="line">    Note over Primary, Backup1, Backup2: Each replica collects PREPARE messages. If enough (2f+1) match, proceed.</div>
<div class="line">    Primary-&gt;&gt;Backup1: Send COMMIT (N=5)</div>
<div class="line">    Primary-&gt;&gt;Backup2: Send COMMIT (N=5)</div>
<div class="line">    Backup1-&gt;&gt;Primary: Send COMMIT (N=5)</div>
<div class="line">    Backup1-&gt;&gt;Backup2: Send COMMIT (N=5)</div>
<div class="line">    Backup2-&gt;&gt;Primary: Send COMMIT (N=5)</div>
<div class="line">    Backup2-&gt;&gt;Backup1: Send COMMIT (N=5)</div>
<div class="line">    Note over Primary, Backup1, Backup2: Each replica collects COMMIT messages. If enough (2f+1) match, consensus reached!</div>
<div class="line">    Primary-&gt;&gt;Executor: Execute Transaction (N=5)</div>
<div class="line">    Backup1-&gt;&gt;Executor: Execute Transaction (N=5)</div>
<div class="line">    Backup2-&gt;&gt;Executor: Execute Transaction (N=5)</div>
<div class="line">    Note over Executor: Transaction Execution discussed in Chapter 5.</div>
<div class="line">    Executor-&gt;&gt;Primary: Execution Result</div>
<div class="line">    Primary-&gt;&gt;Client: Send Response (Success)</div>
<div class="line">    Backup1-&gt;&gt;Executor: Execution Result</div>
<div class="line">    Backup2-&gt;&gt;Executor: Execution Result</div>
</div><!-- fragment --><p><b>Diving Deeper into Code:</b></p>
<p>The <code><a class="el" href="../../d3/d20/classConsensusManagerPBFT.html">ConsensusManagerPBFT</a></code> is set up when a replica starts. Its constructor initializes various helper components:</p>
<div class="fragment"><div class="line"><span class="comment">// Simplified from platform/consensus/ordering/pbft/consensus_manager_pbft.cpp</span></div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="../../d3/d20/classConsensusManagerPBFT.html#a43d8d84560f4dadbbb9b787a494eff19">ConsensusManagerPBFT::ConsensusManagerPBFT</a>(</div>
<div class="line">    <span class="keyword">const</span> <a class="code hl_class" href="../../d6/d06/classResDBConfig.html">ResDBConfig</a>&amp; <a class="code hl_namespace" href="../../d6/d7f/namespaceconfig.html">config</a>, std::unique_ptr&lt;TransactionManager&gt; executor,</div>
<div class="line">    <span class="comment">/* ... other params ... */</span>)</div>
<div class="line">    : ConsensusManager(<a class="code hl_namespace" href="../../d6/d7f/namespaceconfig.html">config</a>), <span class="comment">// Initialize base class</span></div>
<div class="line">      system_info_(std::make_unique&lt;SystemInfo&gt;(<a class="code hl_namespace" href="../../d6/d7f/namespaceconfig.html">config</a>)), <span class="comment">// Holds view/primary info</span></div>
<div class="line">      checkpoint_manager_( <span class="comment">/* ... */</span> ), <span class="comment">// Manages state saving ([Chapter 7](07_checkpointing___recovery__checkpointmanager___recovery_.md))</span></div>
<div class="line">      message_manager_( <span class="comment">/* ... */</span> ), <span class="comment">// Helps manage message state ([Chapter 4](04_message_transaction_collection__transactioncollector___messagemanager_.md))</span></div>
<div class="line">      commitment_(std::make_unique&lt;Commitment&gt;(config_, message_manager_.<a class="code hl_function" href="../../d7/da6/pybind__kv__service_8cpp.html#abe6524afb3a69dc9a4c314e11f96f29f">get</a>(), <span class="comment">/* ... */</span>)), <span class="comment">// Handles PBFT phases</span></div>
<div class="line">      query_( <span class="comment">/* ... */</span> ), <span class="comment">// Handles read requests</span></div>
<div class="line">      response_manager_( <span class="comment">/* ... */</span> ), <span class="comment">// Manages client responses</span></div>
<div class="line">      performance_manager_( <span class="comment">/* ... */</span> ), <span class="comment">// For performance tracking</span></div>
<div class="line">      view_change_manager_(std::make_unique&lt;ViewChangeManager&gt;(config_, <span class="comment">/* ... */</span>)), <span class="comment">// Handles leader changes</span></div>
<div class="line">      recovery_( <span class="comment">/* ... */</span> ) <span class="comment">// Handles startup recovery ([Chapter 7](07_checkpointing___recovery__checkpointmanager___recovery_.md))</span></div>
<div class="line">{</div>
<div class="line">    <span class="comment">// ... Further initialization ...</span></div>
<div class="line">    LOG(INFO) &lt;&lt; <span class="stringliteral">&quot;ConsensusManagerPBFT initialized.&quot;</span>;</div>
<div class="line">}</div>
<div class="ttc" id="aclassConsensusManagerPBFT_html_a43d8d84560f4dadbbb9b787a494eff19"><div class="ttname"><a href="../../d3/d20/classConsensusManagerPBFT.html#a43d8d84560f4dadbbb9b787a494eff19">ConsensusManagerPBFT::ConsensusManagerPBFT</a></div><div class="ttdeci">ConsensusManagerPBFT(const ResDBConfig &amp;config, std::unique_ptr&lt; TransactionManager &gt; executor, std::unique_ptr&lt; CustomQuery &gt; query_executor=nullptr)</div><div class="ttdef"><b>Definition</b> <a href="../../de/de1/consensus__manager__pbft_8cpp_source.html#l00029">consensus_manager_pbft.cpp:29</a></div></div>
<div class="ttc" id="aclassResDBConfig_html"><div class="ttname"><a href="../../d6/d06/classResDBConfig.html">ResDBConfig</a></div><div class="ttdef"><b>Definition</b> <a href="../../d4/d9a/resdb__config_8h_source.html#l00028">resdb_config.h:28</a></div></div>
<div class="ttc" id="anamespaceconfig_html"><div class="ttname"><a href="../../d6/d7f/namespaceconfig.html">config</a></div><div class="ttdef"><b>Definition</b> <a href="../../d4/d0d/ai-tools_2mcp_2resilientdb-mcp_2config_8py_source.html#l00001">config.py:1</a></div></div>
<div class="ttc" id="apybind__kv__service_8cpp_html_abe6524afb3a69dc9a4c314e11f96f29f"><div class="ttname"><a href="../../d7/da6/pybind__kv__service_8cpp.html#abe6524afb3a69dc9a4c314e11f96f29f">get</a></div><div class="ttdeci">std::string get(std::string key, std::string config_path)</div><div class="ttdef"><b>Definition</b> <a href="../../d7/da6/pybind__kv__service_8cpp_source.html#l00039">pybind_kv_service.cpp:39</a></div></div>
</div><!-- fragment --><p><b>Explanation:</b></p>
<ul>
<li>The constructor creates instances of many important classes.</li>
<li><code>Commitment</code>: As mentioned, this is central to processing <code>PRE-PREPARE</code>, <code>PREPARE</code>, and <code>COMMIT</code> messages.</li>
<li><code>ViewChangeManager</code>: Watches for signs that the Primary might be faulty and manages the process of electing a new one if needed.</li>
<li><code>CheckPointManager</code>: Periodically helps replicas agree on a stable, saved state so they don't have to keep all messages forever (Chapter 7).</li>
<li><code>MessageManager</code>: Often works closely with <code>Commitment</code> to store and retrieve messages associated with different sequence numbers (Chapter 4).</li>
<li><code>TransactionManager</code> (passed in as <code>executor</code>): This is the link to actually executing the transaction once consensus is reached (Chapter 5).</li>
</ul>
<p>The <code><a class="el" href="../../d3/d20/classConsensusManagerPBFT.html">ConsensusManagerPBFT</a></code> acts as the high-level coordinator, relying on these specialized components to handle the details of each part of the consensus process.</p>
<h2><a class="anchor" id="autotoc_md111"></a>
Conclusion</h2>
<p>You've now learned about the critical role of the <b>Consensus Manager (<code><a class="el" href="../../d3/d20/classConsensusManagerPBFT.html">ConsensusManagerPBFT</a></code>)</b> in ResilientDB. It's the engine that ensures all replicas agree on the order of transactions, providing the foundation for the database's reliability and fault tolerance.</p>
<ul>
<li>We saw why <b>consensus</b> is essential in a distributed system like ResilientDB.</li>
<li>We met the <code>ConsensusManager</code> as the <b>chief negotiator</b>, orchestrating agreement using algorithms like PBFT.</li>
<li>We walked through a simplified <b>PBFT flow</b> (Pre-Prepare, Prepare, Commit).</li>
<li>We looked at the <code>ConsensusCommit</code> function in <code><a class="el" href="../../d3/d20/classConsensusManagerPBFT.html">ConsensusManagerPBFT</a></code> and how it delegates tasks based on message types to components like <code>Commitment</code> and <code>ViewChangeManager</code>.</li>
</ul>
<p>The <code>ConsensusManager</code> deals with deciding the <em>order</em>. But before consensus can even begin, the replicas need an efficient way to gather all the incoming client transaction requests and the flood of consensus messages (Prepare, Commit votes) being exchanged. How are these messages collected and organized?</p>
<p>That's what we'll explore in the next chapter!</p>
<p><b>Next:</b> <a class="el" href="../../d2/d6d/md__2github_2workspace_2ecosystem_2ai-tools_2beacon_2content_2resilientdb_2chapters_204__message__transaction__collection.html">Chapter 4: Message/Transaction Collection</a></p>
<hr  />
<p>Generated by <a href="https://github.com/The-Pocket/Tutorial-Codebase-Knowledge">AI Codebase Knowledge Builder</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
